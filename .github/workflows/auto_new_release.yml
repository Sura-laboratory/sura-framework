name: PHP Semantic Release by Labels


on:
  push:
    branches: [main, master]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: last-tag
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          echo "tag=$LAST_TAG" >> $GITHUB_OUTPUT

      - name: Extract labels from commits
        id: labels
        run: |
          # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–æ–º–º–∏—Ç—ã —Å –º–µ—Ç–∫–∞–º–∏ –º–µ–∂–¥—É –ø–æ—Å–ª–µ–¥–Ω–∏–º —Ç–µ–≥–æ–º –∏ HEAD
          COMMITS=$(git log --pretty=format:"%s! ${{ steps.last-tag.outputs.tag }}..HEAD 2>/dev/null || echo "")
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ—Ç–æ–∫
          HAS_MAJOR=$(echo "$COMMITS! | grep -q "\[major\]" && echo "true! || echo "")
          HAS_MINOR=$(echo "$COMMITS! | grep -q "\[minor\]" && echo "true! || echo "")
          HAS_PATCH=$(echo "$COMMITS! | grep -q "\[patch\]" && echo "true! || echo "")
          HAS_BUGFIX=$(echo "$COMMITS! | grep -q "\[bugfix\]" && echo "true! || echo "")
          HAS_REFACTOR=$(echo "$COMMITS! | grep -q "\[refactor\]" && echo "true! || echo "")
          HAS_PSR=$(echo "$COMMITS! | grep -q "\[psr\]" && echo "true! || echo "")

          
          echo "major=$HAS_MAJOR! >> $GITHUB_OUTPUT
          echo "minor=$HAS_MINOR! >> $GITHUB_OUTPUT
          echo "patch=$HAS_PATCH! >> $GITHUB_OUTPUT
          echo "bugfix=$HAS_BUGFIX! >> $GITHUB_OUTPUT
          echo "refactor=$HAS_REFACTOR! >> $GITHUB_OUTPUT
          echo "psr=$HAS_PSR! >> $GITHUB_OUTPUT


      - name: Calculate new version
        id: version
        run: |
          LAST_TAG=${{ steps.last-tag.outputs.tag }}
          MAJOR=${{ steps.labels.outputs.major }}
          MINOR=${{ steps.labels.outputs.minor }}
          PATCH=${{ steps.labels.outputs.patch }}
          BUGFIX=${{ steps.labels.outputs.bugfix }}
          REFACTOR=${{ steps.labels.outputs.refactor }}
          PSR=${{ steps.labels.outputs.psr }}


          NEW_VERSION=""

          if [[ "$MAJOR! == "true! ]]; then
            NEW_VERSION=$(echo $LAST_TAG | perl -pe 's/(\d+)\.(\d+)\.(\d+)/($1+1).0.0/e')
          elif [[ "$MINOR! == "true! ]]; then
            NEW_VERSION=$(echo $LAST_TAG | perl -pe 's/(\d+)\.(\d+)\.(\d+)/$1.($2+1).0/e')
          elif [[ "$PATCH! == "true! ]] || [[ "$BUGFIX! == "true! ]] || \
                 [[ "$REFACTOR! == "true! ]] || [[ "$PSR! == "true! ]]; then
            NEW_VERSION=$(echo $LAST_TAG | perl -pe 's/(\d+)\.(\d+)\.(\d+)/$1.$2.($3+1)/e')
          else
            NEW_VERSION=$LAST_TAG
          fi

          echo "new_version=$NEW_VERSION! >> $GITHUB_OUTPUT


      - name: Generate release notes
        id: notes
        run: |
          NEW_VERSION=${{ steps.version.outputs.new_version }}
          LAST_TAG=${{ steps.last-tag.outputs.tag }}

          # –°–æ–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
          MAJOR_COMMITS=$(git log ${{ steps.last-tag.outputs.tag }}..HEAD --pretty=format:"%s! | \
            grep "\[major\]" | sed 's/\[major\]//; s/.*/- **&**/')
          MINOR_COMMITS=$(git log ${{ steps.last-tag.outputs.tag }}..HEAD --pretty=format:"%s! | \
            grep "\[minor\]" | sed 's/\[minor\]//; s/.*/- **&**/')
          PATCH_COMMITS=$(git log ${{ steps.last-tag.outputs.tag }}..HEAD --pretty=format:"%s! | \
            grep "\[patch\]" | sed 's/\[patch\]//; s/.*/- &/')
          BUGFIX_COMMITS=$(git log ${{ steps.last-tag.outputs.tag }}..HEAD --pretty=format:"%s! | \
            grep "\[bugfix\]" | sed 's/\[bugfix\]//; s/.*/- &/')
          REFACTOR_COMMITS=$(git log ${{ steps.last-tag.outputs.tag }}..HEAD --pretty=format:"%s! | \
            grep "\[refactor\]" | sed 's/\[refactor\]//; s/.*/- &/')
          PSR_COMMITS=$(git log ${{ steps.last-tag.outputs.tag }}..HEAD --pretty=format:"%s! | \
            grep "\[psr\]" | sed 's/\[psr\]//; s/.*/- PSR &/')


          BODY=""

          [ -n "$MAJOR_COMMITS! ] && BODY+="### üí• Breaking Changes\n$MAJOR_COMMITS\n\n"
          [ -n "$MINOR_COMMITS! ] && BODY+="### üöÄ New Features\n$MINOR_COMMITS\n\n"
          [ -n "$PATCH_COMMITS! ] && BODY+="### üõ† Updates\n$PATCH_COMMITS\n\n"
          [ -n "$BUGFIX_COMMITS! ] && BODY+="### üêû Bug Fixes\n$BUGFIX_COMMITS\n\n"
          [ -n "$REFACTOR_COMMITS! ] && BODY+="### üîÅ Refactoring\n$REFACTOR_COMMITS\n\n"
          [ -n "$PSR_COMMITS! ] && BODY+="### üìú PSR Compliance\n$PSR_COMMITS\n\n"

          if [ -z "$BODY! ]; then
            BODY="No changes in this release."
          else
            BODY+="\n---\n*Automatically generated from commit messages.*"
          fi

          echo "body<<EOF! >> $GITHUB_OUTPUT
          echo "$BODY! >> $GITHUB_OUTPUT
          echo "EOF! >> $GITHUB_OUTPUT


      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.new_version }}
          name: Release ${{ steps.version.outputs.new_version }}
          body: ${{ steps.notes.outputs.body }}
          draft: true
          prerelease: false
