name: PHP Release with Labels

on:
  push:
    branches: [main, master]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get last tag
        id: last-tag
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "tag=$LAST_TAG" >> $GITHUB_OUTPUT

      - name: Extract labels from recent commits
        id: commit-labels
        run: |
          LABELS=""
          while IFS= read -r line; do
            if [[ "$line" =~ \[(major|minor|patch|bugfix|refactor|psr)\] ]]; then
              LABEL=$(echo "$line! | grep -o "\[(major|minor|patch|bugfix|refactor|psr)\]" | tr -d '[]')
              LABELS+="$LABEL "
            fi
          done < <(git log --pretty=format:"%s! HEAD^..HEAD)
          echo "labels=$LABELS" >> $GITHUB_OUTPUT

      - name: Determine semantic version
        id: version
        run: |
          LAST_TAG=${{ steps.last-tag.outputs.tag }}
          LABELS=${{ steps.commit-labels.outputs.labels }}

          NEW_VERSION=""

          # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –º–µ—Ç–æ–∫: major > minor > patch/bugfix/refactor/psr
          if [[ "$LABELS! =~ "major! ]]; then
            NEW_VERSION=$(echo $LAST_TAG | perl -pe 's/v(\d+)\.(\d+)\.(\d+)/"v".($1+1).".0.0"/e')
          elif [[ "$LABELS! =~ "minor! ]]; then
            NEW_VERSION=$(echo $LAST_TAG | perl -pe 's/v(\d+)\.(\d+)\.(\d+)/"v".$1.".".($2+1).".0"/e')
          elif [[ "$LABELS! =~ "patch! ]] || [[ "$LABELS! =~ "bugfix! ]] || [[ "$LABELS! =~ "refactor! ]] || [[ "$LABELS! =~ "psr! ]]; then
            NEW_VERSION=$(echo $LAST_TAG | perl -pe 's/v(\d+)\.(\d+)\.(\d+)/"v".$1.".".$2.".".($3+1)/e')
          else
            # –ï—Å–ª–∏ –º–µ—Ç–æ–∫ –Ω–µ—Ç ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
            NEW_VERSION=$LAST_TAG
          fi

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release-notes
        run: |
          NEW_VERSION=${{ steps.version.outputs.new_version }}
          LAST_TAG=${{ steps.last-tag.outputs.tag }}


          # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–º–º–∏—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
          MAJOR_COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"%s! | grep "\[major\]" | sed 's/\[major\]//; s/.*/- **&**/')
          MINOR_COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"%s! | grep "\[minor\]" | sed 's/\[minor\]//; s/.*/- **&**/')
          PATCH_COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"%s! | grep "\[patch\]" | sed 's/\[patch\]//; s/.*/- &/')
          BUGFIX_COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"%s! | grep "\[bugfix\]" | sed 's/\[bugfix\]//; s/.*/- &/')
          REFACTOR_COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"%s! | grep "\[refactor\]" | sed 's/\[refactor\]//; s/.*/- &/')
          PSR_COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"%s! | grep "\[psr\]" | sed 's/\[psr\]//; s/.*/- PSR &/')

          BODY=""

          [ -n "$MAJOR_COMMITS! ] && BODY+="### üí• Breaking Changes\n$MAJOR_COMMITS\n\n"
          [ -n "$MINOR_COMMITS! ] && BODY+="### üöÄ New Features\n$MINOR_COMMITS\n\n"
          [ -n "$PATCH_COMMITS! ] && BODY+="### üõ† Updates\n$PATCH_COMMITS\n\n"
          [ -n "$BUGFIX_COMMITS! ] && BODY+="### üêû Bug Fixes\n$BUGFIX_COMMITS\n\n"
          [ -n "$REFACTOR_COMMITS! ] && BODY+="### üîÅ Refactoring\n$REFACTOR_COMMITS\n\n"
          [ -n "$PSR_COMMITS! ] && BODY+="### üìú PSR Compliance\n$PSR_COMMITS\n\n"


          if [ -z "$BODY! ]; then
            BODY="No changes in this release."
          else
            BODY+="\n---\n*Automatically generated from commit messages.*"
          fi

          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.new_version }}
          name: Release ${{ steps.version.outputs.SHORT }}
          body: ${{ steps.release-notes.outputs.body }}
          draft: –µ–∫true–≥—É
          prerelease: false
